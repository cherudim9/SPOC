#lab0 SPOC思考题 - 答案

##funcall

###funcall中的堆栈有多大？是内核态堆栈还是用户态堆栈

128MB-4MB-代码长度-数据区大小。内核态（根据debugger的消息提示可判断）。

###funcall中的全局变量ret放在内存中何处？如何对它寻址？

代码和字符串后面。（0x0000 00a6）

用`xpc-tpc+(ir>>8)`寻址。

###funcall中的字符串放在内存中何处？如何对它寻址？

放在代码后面。（0x0000 0090）

用`xpc-tpc+(ir>>8)`寻址。

###局部变量i在内存中的何处？如何对它寻址？
当进入`write`函数块后，执行了`ENT -8`指令，分配了一个64位的栈空间给`i`（虽然实际上变量`i`只需要32位的空间），之后通过`*(sp+4)`访问`i`。

###当前系统是处于中断使能状态吗？

不在。（根据debugger的消息提示可判断）

###funcall中的函数参数是如何传递的？函数返回值是如何传递的？
在使用JSR调用函数之前，先把所有参数（按从右到左）用`PSHA`之类的压栈指令把参数放到栈中；

函数执行结束后，返回值放在寄存器`a`中。

###分析并说明funcall执行文件的格式和内容

- 00000000~00000003: Magic Number 0xC0DEF00D
- 00000004~00000007: bss，代码区的长度
- 00000008~0000000b: entry，代码的入口位置（即main函数的定义）
- 0000000c~0000000f: flags，值为0
- 00000010~0000009c: 代码内容
- 000000a0~000000b4: 字符串常量

#OS1.c

###何处设置的中断使能？

当执行到C代码中`asm(STI）`的时候，打开了中断使能；之前是关闭的。

###系统何时处于中断屏蔽状态？

两种情况：

1. 在执行到C代码中的`asm(STI）`之前；
2. 处理时钟中断的时候。

###如果系统处于中断屏蔽状态，如何让其中断使能？

使用`STI`（当且仅当无中断时被调用）或者`RTI`指令。

###系统产生中断后，CPU会做哪些事情？（在没有软件帮助的情况下）

在`em.c`的`interrupt:`标记下，可以看到CPU做了以下事情：

1. 从用户栈切换到内核栈；
2. 更换快表（`tr`设置为`trk`，`tw`设置为`twk`）；
3. 把当前的`pc`压栈（为了备份）；
4. 把当前的异常编号`trap`压栈（为了备份）；
5. 修改`pc`到异常处理向量`ivec`处。

###CPU执行RTI指令的具体完成工作是哪些？

1. 判断先决条件：处在内核态；
2. 从内核栈切换到用户栈；
3. 更换快表（`tr`设置为`tru`，`tw`设置为`twu`）；
4. 从栈中获取之前保存的异常处`pc`；
5. 从栈中获取之前保存的异常编号`trap`；
6. 重新打开终端使能。
